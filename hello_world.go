package main

import (
	"fmt"
	"runtime"
	"time"
)

// Shared: state ‡∏£‡πà‡∏ß‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á goroutine "hello" ‡πÅ‡∏•‡∏∞ "world"
type Shared struct {
	count int      // ‡∏ô‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö 1..max
	turn  string   // "hello" ‡∏´‡∏£‡∏∑‡∏≠ "world" (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡πÉ‡∏Ñ‡∏£)
	out   []string // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô slice ‡∏Ç‡∏≠‡∏á string ‡πÄ‡∏ä‡πà‡∏ô "1 hello"
}

// say ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÉ‡∏ô goroutine
//
// ‚ö†Ô∏è ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Race Condition! ‚ö†Ô∏è
//
// ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢:
//  1. ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter mu *sync.Mutex ‡πÅ‡∏•‡∏∞ wg *sync.WaitGroup
//  2. ‡πÄ‡∏û‡∏¥‡πà‡∏° defer wg.Done() ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
//  3. ‡πÄ‡∏û‡∏¥‡πà‡∏° mu.Lock() / mu.Unlock() ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
//  4. ‡∏•‡∏ö time.Sleep ‡∏≠‡∏≠‡∏Å
func say(
	word, other string,
	max int,
	s *Shared,
	done *bool,
	mu *sync.Mutex,
	wg *sync.WaitGroup)
{
	// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter mu *sync.Mutex, wg *sync.WaitGroup ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
	// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° defer wg.Done() ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å WaitGroup ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
	defer wg.Done()
	for {
		// ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ mutex lock - ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î race condition ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢ goroutine ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô!
		// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° mu.Lock() ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á shared state
		mu.Lock()

		// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
		if *done {
			// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° mu.Unlock() ‡∏Å‡πà‡∏≠‡∏ô return
			mu.Unlock()
			return
		}

		// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á goroutine ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
		if s.turn != word {
			// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° mu.Unlock() ‡∏Å‡πà‡∏≠‡∏ô continue
			time.Sleep(1 * time.Millisecond) // ‚ö†Ô∏è ‡πÉ‡∏ä‡πâ sleep ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ sync ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡πÑ‡∏°‡πà‡∏î‡∏µ!
			mu.Unlock()
			continue
		}

		// ---- critical section (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition!) ----
		s.count++
		line := fmt.Sprintf("%d %s", s.count, word)
		s.out = append(s.out, line)
		fmt.Println(line) // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

		// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
		if s.count >= max {
			*done = true
			// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° mu.Unlock() ‡∏Å‡πà‡∏≠‡∏ô return
			mu.Unlock()
			return
		}

		// ‡∏™‡πà‡∏á‡∏ï‡∏≤‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å goroutine ‡∏´‡∏ô‡∏∂‡πà‡∏á
		s.turn = other

		// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° mu.Unlock() ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
		mu.Unlock()
	}
}

// HelloWorldSync ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å test
//
// ‚ö†Ô∏è ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:
//   - ‡πÑ‡∏°‡πà‡∏°‡∏µ Mutex ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î race condition
//   - ‡πÉ‡∏ä‡πâ time.Sleep ‡πÅ‡∏ó‡∏ô WaitGroup (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ú‡∏¥‡∏î)
//   - ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
//
// ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ:
//   - ‡πÄ‡∏û‡∏¥‡πà‡∏° sync.Mutex ‡πÅ‡∏•‡∏∞ sync.WaitGroup
//   - ‡∏™‡πà‡∏á mutex ‡πÅ‡∏•‡∏∞ waitgroup ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô say
//   - ‡πÉ‡∏ä‡πâ wg.Add(2) ‡πÅ‡∏•‡∏∞ wg.Wait() ‡πÅ‡∏ó‡∏ô time.Sleep
//   - ‡πÄ‡∏û‡∏¥‡πà‡∏° lock/unlock ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô say

func HelloWorldSync(max int) []string {
	if max <= 0 {
		return []string{}
	}

	// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° shared state ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
	s := Shared{
		count: 0,
		turn:  "hello", // ‡πÉ‡∏´‡πâ "hello" ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô
		out:   make([]string, 0, max),
	}

	var done bool

	// TODO: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
	var mu sync.Mutex
	var wg sync.WaitGroup

	// TODO: ‡∏ö‡∏≠‡∏Å WaitGroup ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ 2 goroutines
	wg.Add(2)

	// ‡∏™‡∏£‡πâ‡∏≤‡∏á goroutine 2 ‡∏ï‡∏±‡∏ß
	// TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° &mu ‡πÅ‡∏•‡∏∞ &wg ‡πÄ‡∏õ‡πá‡∏ô parameter ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô say ‡πÅ‡∏•‡πâ‡∏ß
	go say("hello", "world", max, &s, &done, &mu, &wg)
	go say("world", "hello", max, &s, &done, &mu, &wg)

	// ‚ö†Ô∏è ‡πÉ‡∏ä‡πâ sleep ‡πÅ‡∏ó‡∏ô WaitGroup - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ú‡∏¥‡∏î!
	// ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô goroutine ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
	// TODO: ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ wg.Wait() ‡πÅ‡∏ó‡∏ô
	wg.Wait()

	// ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 10 ‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏£‡∏≤‡∏∞ race condition!)
	return s.out
}

// main ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
func main() {
	// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô CPU cores ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
	numCPU := runtime.NumCPU()
	runtime.GOMAXPROCS(numCPU)

	max := 100 // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå

	fmt.Println("=== ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Race Condition) ===")
	fmt.Printf("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô CPU cores: %d\n", numCPU)
	fmt.Println("‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏û‡∏¥‡∏°‡∏û‡πå hello ‡πÅ‡∏•‡∏∞ world ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô", max, "‡∏Ñ‡∏£‡∏±‡πâ‡∏á")
	fmt.Println()

	// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô HelloWorldSync
	result := HelloWorldSync(max)

	fmt.Println()
	fmt.Println("=== ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ===")
	fmt.Printf("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: %d (‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á: %d)\n", len(result), max)

	if len(result) != max {
		fmt.Println("‚ö†Ô∏è ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç race condition")
	} else {
		fmt.Println("‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ race condition!")
		fmt.Println("\n‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:")
		for _, line := range result {
			fmt.Println(line)
		}
	}

	fmt.Println()
	fmt.Println("üìù ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:")
	fmt.Println("1. ‡πÄ‡∏û‡∏¥‡πà‡∏° sync.Mutex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition")
	fmt.Println("2. ‡πÄ‡∏û‡∏¥‡πà‡∏° sync.WaitGroup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ goroutine ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à")
	fmt.Println("3. ‡πÄ‡∏û‡∏¥‡πà‡∏° mu.Lock() / mu.Unlock() ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°")
	fmt.Println("4. ‡∏•‡∏ö time.Sleep ‡∏≠‡∏≠‡∏Å")
	fmt.Println()
	fmt.Println("üí° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö race condition ‡∏î‡πâ‡∏ß‡∏¢:")
	fmt.Println("   go run -race hello_world.go")
}
